<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.plcs.web.wsxd.businessoperation.businessoperation.dao.WsxdCaseDao">
	<sql id="wsxdCaseColumns">
		a.id AS "id",
		a.app_org AS "appOrg",
		a.app_org AS "appOrgName",
		a.department_id AS "departmentId",
		a.department_name AS "departmentName",
		a.loan_orgin AS "loanOrgin",
		a.loan_bill_no AS "loanBillNo",
		a.customer_name AS "customerName",
		a.customer_id_no AS "customerIdNo",
		a.loan_balance AS "loanBalance",
		a.overdue_days AS "overdueDays",
		a.overdue_amt AS "overdueAmt",
		a.realtime_overdue_days AS "realtimeOverdueDays",
		a.realtime_overdue_amt AS "realtimeOverdueAmt",
		a.app_name AS "appName",
		a.case_status AS "caseStatus",
		b.create_date AS "createDate",
		b.remind_status AS "remindStatus",
		c.odv_name AS "odvName",
		c.odv_group_name AS "odvGroupName",
        a.source_core As "sourceCore"
	</sql>
	
	<sql id="wsxdCaseJoins">
		LEFT JOIN (
			SELECT
				aa.*
			FROM
			(
				SELECT
					loan_bill_no, phone, status AS remind_status, create_date
				FROM
					wsxd_remind_record
				ORDER BY
					update_date DESC
			) aa
			GROUP BY aa.loan_bill_no
			) b ON a.loan_bill_no = b.loan_bill_no
		LEFT JOIN wsxd_allocate_hst c ON a.loan_bill_no = c.loan_bill_no AND c.end_date IS NULL
		LEFT JOIN wsxd_contact_phone d ON a.customer_id_no = d.customer_id_no
	</sql>
    
	<select id="get" resultType="WsxdCase">
		SELECT
			<choose>
				<when test="find !=null and find == 'no'">
					<include refid="wsxdCaseColumnsDemo"/>
				</when>
				<otherwise>
					<include refid="wsxdCaseColumns"/>
				</otherwise>
			</choose>
		FROM wsxd_case a
		<choose>
			<when test="find !=null and find == 'no'">
				<include refid="wsxdCaseJoinsDemo"/>
			</when>
			<otherwise>
				<include refid="wsxdCaseJoins"/>
			</otherwise>
		</choose>
		WHERE a.id = #{id}
        GROUP BY a.loan_bill_no
	</select>

	<select id="findByLoanBillNo" resultType="WsxdCase">
		SELECT
		<include refid="wsxdCaseColumns"/>
		FROM wsxd_case a
		<include refid="wsxdCaseJoins"/>
		WHERE a.loan_bill_no = #{loanBillNo}
		GROUP BY a.loan_bill_no
	</select>

	<select id="getByLoanBillNo" resultType="WsxdCase">
		SELECT *
		FROM wsxd_case
		WHERE loan_bill_no = #{loanBillNo}
		limit 1;
	</select>

	<select id="findList" resultType="WsxdCase">
		SELECT
		<choose>
			<when test="find !=null and find == 'no'">
				<include refid="wsxdCaseColumnsDemo"/>
			</when>
			<otherwise>
				<include refid="wsxdCaseColumns"/>
			</otherwise>
		</choose>
		FROM wsxd_case a
		<choose>
			<when test="find !=null and find == 'no'">
				<include refid="wsxdCaseJoinsDemo"/>
			</when>
			<otherwise>
				<include refid="wsxdCaseJoins"/>
			</otherwise>
		</choose>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="appOrg != null and appOrg != ''">
				AND a.app_org = #{appOrg}
			</if>
			<if test="loanBillNo != null and loanBillNo != ''">
				AND a.loan_bill_no = #{loanBillNo}
			</if>
			<if test="departmentId != null and departmentId != ''">
				AND a.department_id = #{departmentId}
			</if>
			<if test="loanOrgin != null and loanOrgin != ''">
				AND a.loan_orgin = #{loanOrgin}
			</if>
			<if test="appNo != null and appNo != ''">
				AND a.app_no = #{appNo}
			</if>
			<if test="customerName != null and customerName != ''">
				AND a.customer_name = #{customerName}
			</if>
			<if test="customerIdNo != null and customerIdNo != ''">
				AND a.customer_id_no LIKE CONCAT('%',#{customerIdNo},'%')
			</if>
			<if test="minOverdueDays != null and minOverdueDays != ''">
				AND a.overdue_days &gt;= #{minOverdueDays}
			</if>
			<if test="maxOverdueDays != null and maxOverdueDays != ''">
				AND a.overdue_days &lt;= #{maxOverdueDays}
			</if>
			<if test="remindStatus != null and remindStatus != ''">
				AND b.status = #{remindStatus}
			</if>
			<!-- 默认加载逾期状态的案件 -->
			<if test="search != null and search == 'no'">
				AND a.case_status = '01'
			</if>
			<if test="caseStatus != null and caseStatus != ''">
				AND a.case_status = #{caseStatus}
			</if>
			<if test="telephoneNo != null and telephoneNo != ''">
				AND (b.phone = #{telephoneNo} OR d.phone = #{telephoneNo})
			</if>
			<if test="odvName != null and odvName != ''">
				AND c.odv_name = #{odvName}
			</if>
			<if test="permissionOdv != null and permissionOdv != ''">
				AND c.odv = #{permissionOdv}
			</if>
			<if test="managerId != null and managerId != ''">
				AND a.manager_id = #{managerId}
			</if>
			<choose>
				<!-- 查询线下产品 -->
				<when test="appName != null and appName == 'offline_product'">
					AND a.app_name IN(
					SELECT sys_dict.value
					FROM sys_dict
					WHERE sys_dict.type = 'product_type' AND sys_dict.description = '进件通路'
					)
				</when>

				<!-- 查询线上产品 -->
				<when test="appName != null and appName != ''">
					AND a.app_name in
					<foreach collection="appNameList" item="name" index="index" open="(" close=")" separator=",">
						#{name}
					</foreach>
				</when>
			</choose>
		</where>
        GROUP BY a.loan_bill_no
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.customer_id_no DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="WsxdCase">
		SELECT 
			<include refid="wsxdCaseColumns"/>
		FROM wsxd_case a
		<include refid="wsxdCaseJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>
        GROUP BY a.loan_bill_no
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>


	<select id="findRealList" resultType="WsxdCase">
		SELECT
		<include refid="wsxdCaseColumns"/>
		FROM wsxd_case a
		<include refid="wsxdCaseJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="appOrg != null and appOrg != ''">
				AND a.app_org = #{appOrg}
			</if>
			<if test="loanBillNo != null and loanBillNo != ''">
				AND a.loan_bill_no = #{loanBillNo}
			</if>
			<if test="departmentId != null and departmentId != ''">
				AND a.department_id = #{departmentId}
			</if>
			<choose>
				<when test="loanOrgin != null and loanOrgin != ''">
					AND a.loan_orgin = #{loanOrgin}
				</when>
				<otherwise>
					AND a.loan_orgin IN ("${@com.plcs.web.common.constant.LoanOrgConstants@HAIER}","${@com.plcs.web.common.constant.LoanOrgConstants@HAIER_TWO}")
				</otherwise>
			</choose>

			<if test="appNo != null and appNo != ''">
				AND a.app_no = #{appNo}
			</if>
			<if test="customerName != null and customerName != ''">
				AND a.customer_name = #{customerName}
			</if>
			<if test="customerIdNo != null and customerIdNo != ''">
				AND a.customer_id_no LIKE CONCAT('%',#{customerIdNo},'%')
			</if>
			<if test="telephoneNo != null and telephoneNo != ''">
				AND (b.phone = #{telephoneNo} OR d.phone = #{telephoneNo})
			</if>
			<if test="odvName != null and odvName != ''">
				AND c.odv_name = #{odvName}
			</if>
			<if test="minOverdueDays != null and minOverdueDays != ''">
				AND a.overdue_days &gt;= #{minOverdueDays}
			</if>
			<if test="maxOverdueDays != null and maxOverdueDays != ''">
				AND a.overdue_days &lt;= #{maxOverdueDays}
			</if>

		</where>
		GROUP BY a.loan_bill_no
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.customer_id_no DESC
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO wsxd_case(
			id,
			data_date,
			app_org,
			department_id,
			department_name,
			loan_orgin,
			cust_level,
			app_no,
			loan_bill_no,
			customer_name,
			customer_id_no,
			manager_id,
			manager_name,
			team_manager_name,
			is_first_overdue,
			loan_date,
			due_date,
			bill_date,
			loan_terms,
			loan_prin,
			interest,
			is_settle,
			loan_term_fee,
			account_fee,
			current_debt,
			loan_balance,
			last_interest,
			last_loan_balance,
			last_account_fee,
			overdue_term,
			overdue_prin,
			overdue_int,
			overdue_fee,
			overdue_account_fee,
			overdue_late_fee,
			overdue_penalty,
			overdue_compound,
			overdue_days,
			overdue_amt,
			realtime_overdue_days,
			realtime_overdue_amt,
			app_type,
			app_name,
			case_type,
			case_status,
			source_core,
			present_date,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
		) VALUES (
			#{id},
			#{dataDate},
			#{appOrg},
			#{departmentId},
			#{departmentName},
			#{loanOrgin},
			#{custLevel},
			#{appNo},
			#{loanBillNo},
			#{customerName},
			#{customerIdNo},
			#{managerId},
			#{managerName},
			#{teamManagerName},
			#{isFirstOverdue},
			#{loanDate},
			#{dueDate},
			#{billDate},
			#{loanTerms},
			#{loanPrin},
			#{interest},
			#{isSettle},
			#{loanTermFee},
			#{accountFee},
			#{currentDebt},
			#{loanBalance},
			#{lastInterest},
			#{lastLoanBalance},
			#{lastAccountFee},
			#{overdueTerm},
			#{overduePrin},
			#{overdueInt},
			#{overdueFee},
			#{overdueAccountFee},
			#{overdueLateFee},
			#{overduePenalty},
			#{overdueCompound},
			#{overdueDays},
			#{overdueAmt},
			#{realtimeOverdueDays},
			#{realtimeOverdueAmt},
			#{appType},
			#{appName},
			#{caseType},
			#{caseStatus},
			#{sourceCore},
			#{presentDate},
			#{createBy},
			#{createDate},
			#{updateBy},
			#{updateDate},
			#{remarks},
			#{delFlag}
		)
	</insert>
	
	<update id="update">
		UPDATE wsxd_case SET 	
			data_date = #{dataDate},
			app_org = #{appOrg},
			department_id = #{departmentId},
			department_name = #{departmentName},
			loan_orgin = #{loanOrgin},
			cust_level = #{custLevel},
			app_no = #{appNo},
			loan_bill_no = #{loanBillNo},
			customer_name = #{customerName},
			customer_id_no = #{customerIdNo},
			manager_id = #{managerId},
			manager_name = #{managerName},
			team_manager_name = #{teamManagerName},
			is_first_overdue = #{isFirstOverdue},
			loan_date = #{loanDate},
			due_date = #{dueDate},
			bill_date = #{billDate},
			loan_terms = #{loanTerms},
			loan_prin = #{loanPrin},
			interest = #{interest},
			is_settle = #{isSettle},
			loan_term_fee = #{loanTermFee},
			account_fee = #{accountFee},
			current_debt = #{currentDebt},
			loan_balance = #{loanBalance},
			last_interest = #{lastInterest},
			last_loan_balance = #{lastLoanBalance},
			last_account_fee = #{lastAccountFee},
			overdue_term = #{overdueTerm},
			overdue_prin = #{overduePrin},
			overdue_int = #{overdueInt},
			overdue_fee = #{overdueFee},
			overdue_account_fee = #{overdueAccountFee},
			overdue_late_fee = #{overdueLateFee},
			overdue_penalty = #{overduePenalty},
			overdue_compound = #{overdueCompound},
			overdue_days = #{overdueDays},
			overdue_amt = #{overdueAmt},
			realtime_overdue_days = #{realtimeOverdueDays},
			realtime_overdue_amt = #{realtimeOverdueAmt},
			app_type = #{appType},
			app_name = #{appName},
			case_type = #{caseType},
			case_status = #{caseStatus},
			source_core = #{sourceCore},
			present_date = #{presentDate},
			update_by = #{updateBy},
			update_date = #{updateDate},
			remarks = #{remarks}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE wsxd_case SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>

	<select id="selectDepartmentList" resultType="com.plcs.web.wsxd.businessoperation.businessoperation.vo.DepartmentVO">
		SELECT department_id AS departmentId, department_name AS departmentName
		FROM wsxd_case
		WHERE del_flag = '0' AND department_name IS NOT NULL
		GROUP BY department_id
	</select>

	<select id="selectLoanOrginList" resultType="java.lang.String">
		SELECT loan_orgin AS loanOrgin
		FROM wsxd_case
		WHERE del_flag = '0' AND loan_orgin IS NOT NULL
		GROUP BY loan_orgin
	</select>

	<select id="selectManagerList" resultType="com.plcs.web.wsxd.businessoperation.businessoperation.vo.ManagerVO">
		SELECT manager_id AS managerId, manager_name AS managerName
		FROM wsxd_case
		WHERE del_flag = '0' AND manager_name IS NOT NULL
		GROUP BY manager_id
	</select>

	<select id="selectProductNameList" resultType="com.plcs.web.wsxd.businessoperation.businessoperation.vo.ProductNameVO">
		SELECT value AS productCode, label AS productName, description
		FROM sys_dict
		WHERE del_flag = '0' AND type = 'product_type'
	</select>

	<select id="findBaseInfo" resultType="WsxdCase">
		SELECT
			a.loan_bill_no,
			a.customer_name,
			concat(substring(a.customer_id_no, 1, 10), '********') as customer_id_no,
			case b.gender
			when 0 then '男性'
			when 1 then '女性'
			else b.gender
			end as gender,
			b.company,
			b.marital_status,
			b.mate_name,
			b.mail,
			a.department_name,
			concat(substring(b.mate_id_no, 1, 10), '********') as mate_id_no,
			c.odv_name as odv,
			a.manager_name,
			CASE WHEN sd3.description = '进件通路' THEN '线下产品'
			ELSE sd3.label END AS app_name,
			a.realtime_overdue_days,
			a.overdue_days,
			a.overdue_compound,
			a.realtime_overdue_amt,
			a.overdue_amt,
			a.overdue_late_fee,
			a.is_first_overdue,
			a.overdue_prin,
			a.overdue_fee,
			a.overdue_start_date,
			a.overdue_int,
			a.loan_balance,
			a.overdue_count,
			a.overdue_penalty,
			a.data_date
		FROM wsxd_case a
		left join wsxd_customer_info b
		on a.customer_id_no = b.customer_id_no
		left join wsxd_allocate_hst c
		on a.loan_bill_no = c.loan_bill_no and c.end_date is null
		LEFT JOIN sys_dict sd3 ON sd3.type="product_type" AND a.app_name = sd3.value
		where a.loan_bill_no = #{loanBillNo}
		limit 1
	</select>

	<select id="findCardInfo" resultType="WsxdCase">
		select
			a.loan_bill_no,
			case a.app_org
				when 01 then '网商'
				when 02 then '玖康'
				when 03 then '分蛋'
				when 04 then '嘉禾'
				when 05 then '机构一商润贷'
			else a.app_org end as app_org,
			a.app_no,
			a.loan_prin,
			a.loan_balance,
			a.loan_date,
			a.due_date,
			a.loan_terms,
			a.bill_date,
			a.overdue_start_date,
		    a.source_core,
			b.bank_card_no
		from wsxd_case a
		left join wsxd_customer_info b
		on a.customer_id_no = b.customer_id_no
		where a.customer_id_no = (
			select distinct a.customer_id_no
			from wsxd_case a
			where a.loan_bill_no = #{loanBillNo}
			limit 1
		)
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.update_date DESC
			</otherwise>
		</choose>
	</select>

	<!-- 根据type、value查询字典表 -->
	<select id="findDictByTypeAndValue" parameterType="com.plcs.web.modules.sys.entity.Dict" resultType="com.plcs.web.modules.sys.entity.Dict">
		SELECT value, label, description
		FROM sys_dict a
		WHERE a.value = #{value} AND a.type = #{type}
	</select>

	<sql id="wsxdCaseColumnsDemo">
		a.id AS "id",
		sd.label AS "appOrg",
		a.app_org AS "appOrgName",
		a.department_id AS "departmentId",
		a.department_name AS "departmentName",
		sd1.label AS "loanOrgin",
		a.loan_bill_no AS "loanBillNo",
		a.customer_name AS "customerName",
		a.customer_id_no AS "customerIdNo",
		a.loan_balance AS "loanBalance",
		a.overdue_days AS "overdueDays",
		a.overdue_amt AS "overdueAmt",
		a.realtime_overdue_days AS "realtimeOverdueDays",
		a.realtime_overdue_amt AS "realtimeOverdueAmt",
		CASE WHEN sd3.description = '进件通路' THEN '线下产品'
		ELSE sd3.label END AS "appName",
		sd2.label AS "caseStatus",
		b.create_date AS "createDate",
		b.remind_status AS "remindStatus",
		c.odv_name AS "odvName",
		c.odv_group_name AS "odvGroupName",
        a.source_core As "sourceCore"
	</sql>

	<sql id="wsxdCaseJoinsDemo">
		LEFT JOIN (
			SELECT
				aa.*,sd.label as remind_status
			FROM
			(
				SELECT
					loan_bill_no, phone, status, create_date
				FROM
					wsxd_remind_record
				ORDER BY
					update_date DESC
			) aa
			LEFT JOIN sys_dict sd ON sd.type = 'remind_status' AND sd.value = aa.status
			GROUP BY aa.loan_bill_no
			) b ON a.loan_bill_no = b.loan_bill_no
		LEFT JOIN (
			SELECT
				loan_bill_no, odv, odv_name, odv_group_name, end_date
			FROM
				wsxd_allocate_hst
			 WHERE end_date IS NULL
		) c ON a.loan_bill_no = c.loan_bill_no
		LEFT JOIN wsxd_contact_phone d ON a.customer_id_no = d.customer_id_no
		LEFT JOIN sys_dict sd ON sd.type="appOrg" AND a.app_org=sd.value
		LEFT JOIN sys_dict sd1 ON sd1.type="loan_orgin" AND a.loan_orgin = sd1.value
		LEFT JOIN sys_dict sd2 ON sd2.type="case_status" AND a.case_status = sd2.value
		LEFT JOIN sys_dict sd3 ON sd3.type="product_type" AND a.app_name = sd3.value
	</sql>
</mapper>